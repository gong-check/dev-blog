{"componentChunkName":"component---src-templates-blog-post-js","path":"/BE/쿼리치/nonstop-deployment/nonstop-deployment/","result":{"data":{"site":{"siteMetadata":{"title":"공책 팀 개발 블로그"}},"markdownRemark":{"id":"70417758-545e-518c-9cf1-5bb8c7cfbcdd","excerpt":"무중단 배포란? 서비스를 운영할 때 새로운 버전을 배포하는 동안 운영중인 애플리케이션이 종료되는 문제가 있다. 이런 문제는 사용자에게 안 좋은 경험을 제공하기 때문에 서비스가 정지되지 않고 배포할 수 있는 환경을 구성하기 위한 여러 전략이 존재한다. 무중단 배포 전략 Rolling…","html":"<h2>무중단 배포란?</h2>\n<hr>\n<p>서비스를 운영할 때 새로운 버전을 배포하는 동안 운영중인 애플리케이션이 종료되는 문제가 있다.</p>\n<p>이런 문제는 사용자에게 안 좋은 경험을 제공하기 때문에 서비스가 정지되지 않고 배포할 수 있는 환경을 구성하기 위한 여러 전략이 존재한다.</p>\n<h3>무중단 배포 전략</h3>\n<ul>\n<li>Rolling Update</li>\n<li>Blue-Green Deployment</li>\n<li>Canary Release</li>\n</ul>\n<h2>Rolling Update</h2>\n<hr>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/21b4d/Untitled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5UlEQVQoz22Sz0/TcBjG+d+4GG8aE6OJHjx48kIMFw/EBBMVQSdOhIgaJAG0QuIIqEjQsLlswAi0Xbu2W/ejY92+pWPr1q79/jRuiy7qc/+8eZ7nfYYYY5RSggKCfOh32D/CsMMoYf/TEGPM84OEWIwd6QdpXa16ZgPmLd+oB727cV4XS2eghdWqX3U82weWByijfdhuo5sL2Ssv5Olt8/wUf/9j/tpcZmRRYYwRSkdWCpemhdCX0vBDcfLT0bIYnk2GEEF9+LQFb8zLV58LTz4bF56KExvF63Py6LL2yzOhtxbVy2Eh/LV87lE6tMVz0uyr1Az+DRPK6i62HFgog31eK4Mzy4FW0+8Fa3aYZpxmsiXNsK1GW9FlJZ8h3Ra6MMaVygkMfEowRj4dqIcQAmqmYRSyWRXBgFIaBAFC6E9hDReOceqd97lEKflBehsv7UYy3HZus2uKRERuKfU6mttZEd7EijtbufV1hcME92HgwIthefjBMcev3tsdXZWWHsfH5w+e9eCXqdBEdGxDW7v7/fY7YWFmb3LqxzgisA93AhzZL68lDN3OJ/NR6UQ4NPZUS+q9SgLCcSWVA0pM+5appiUgCObhQGZCmnatVQeMsbbjAhN4be+vPbiOa9fstuMOjuQnwVULSoUvPe8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/f058b/Untitled.png\"\n        srcset=\"/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/c26ae/Untitled.png 158w,\n/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/6bdcf/Untitled.png 315w,\n/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/f058b/Untitled.png 630w,\n/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/40601/Untitled.png 945w,\n/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/78612/Untitled.png 1260w,\n/dev-blog/static/b7978d5e24afd954426ab14aeb985b88/21b4d/Untitled.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>롤링 전략은 사용중인 인스턴스 내에서 새 버전을 교체하는 가장 기본적인 전략이다. 서비스중인 인스턴스 하나를 로드밸런서에서 라우팅하지 않도록 한 뒤 새 버전을 적용하여 다시 라우팅하는 전략으로 모든 인스턴스를\n순차적으로 새로운 버전으로 교체하는 전략이다.</p>\n<h3>장점</h3>\n<ul>\n<li>롤링 전략은 구성된 자원을 그대로 유지한 채로 무중단 배포가 가능하기에 관리가 편하다.</li>\n<li>인스턴스마다 차례로 배포를 진행하기 때문에 상황에 따라 손쉽게 롤백이 가능하다.</li>\n</ul>\n<h3>단점</h3>\n<ul>\n<li>롤링 전략은 인스턴스가 제한적일 경우에 사용되며 새 버전을 배포할 때 기존 트래픽을 감당하던 인스턴스 수가 감소하기 때문에 서비스 처리 용량을 고려해야 한다.</li>\n<li>배포가 진행되는 동안 구버전과 신버전이 공존하기 때문에 호환성 문제가 발생할 수 있다.</li>\n</ul>\n<h2>Blue-Green Deployment</h2>\n<hr>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/6253a114809880355c8f5d9dcac77667/21b4d/Untitled_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.0506329113924%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAACU0lEQVQoz22Sy2/TQBDG+39xRhw4c0EUgeDAgVMDN4LUQOmTtiBTKRUIJIR4qFWrPqBUqoqQALVVHxBSmsR27DgvJ078ynrttXenxA4RibqH1Xq+/c14v5kB6F2GYei63hdkjAFAtVpVVbX7CQAD/8sIoWQyyXGcaZrdIKUUABRFicfjsVgsSh1JHTi6cXB4NDQUi925u7O72w1G+/7+Acc9m5mZzWSz/XB3uRg7yMLIpoHf99u2ZWLHcR3EwnQdONIalvN262T85ebo840P2yd1A4Vl21JZs19v/hp98XHi1ed3W78t5IVUCNMQzpf1a4/WBhMrVxIrtyY3hFL7bb4fAEBarN0cW74+sjT4YPH29JraaEUlewzDDhJFQRByCHVkx3G6XRAFviDLUbo+t8FEnqojWdWRSxiwgFJgbf8ZgE+ZH4Dl2iY2bM8mAemBAUC3EMIudknwz4+oed2zT31CiUNaro87cPTgQ9keXpan1iXkQsUurGYWlv+8150mI0SsOWPrxeGlvGZS06uvZhYW029qrUobDkI/P/1snJ9IXZzc12zGN9PT3x6Of71fscpA6YFkXphKnUvsyjWiInn6+8jol3v5Jh9WDuHtY/3yXPrGfEpvMbF5Mr/3ZG7nca2lQhCkFOtqMn3p6VFRIzVUSO7Ncj8mFENqw9GcWi2cyoiiUm7Piefm8llB5olPMMau5x/npIxQoAw83+XlXC6fJb53xoRJUr6oFM80jOf5UqkEDM5oVUAZpazRaGiaFh5p1GoGocSgrtUN3QhoEEl/4VNV/DD2zU+3iAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled_1\"\n        title=\"Untitled_1\"\n        src=\"/dev-blog/static/6253a114809880355c8f5d9dcac77667/f058b/Untitled_1.png\"\n        srcset=\"/dev-blog/static/6253a114809880355c8f5d9dcac77667/c26ae/Untitled_1.png 158w,\n/dev-blog/static/6253a114809880355c8f5d9dcac77667/6bdcf/Untitled_1.png 315w,\n/dev-blog/static/6253a114809880355c8f5d9dcac77667/f058b/Untitled_1.png 630w,\n/dev-blog/static/6253a114809880355c8f5d9dcac77667/40601/Untitled_1.png 945w,\n/dev-blog/static/6253a114809880355c8f5d9dcac77667/78612/Untitled_1.png 1260w,\n/dev-blog/static/6253a114809880355c8f5d9dcac77667/21b4d/Untitled_1.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>운영 환경에서 구 버전과 동일하게 신 버전을 배포하고 일제히 전환하여 모든 트래픽을 신 버전으로 전환하는 전략이다. 블루 그린 전략은 물리적인 서버를 대상으로 사용하기에는 비용상 버겁다. 그래서 클라우드 환경에서\n쉽게 인스턴스를 생성하거나 없앨 수 있는 AWS 나 Docker 와 같은 가상 환경에서 사용하는 것이 효과적이다.</p>\n<h3>장점</h3>\n<ul>\n<li>롤링 전략과 마찬가지로 빠른 롤백이 가능하다.</li>\n<li>구버전과 동일한 환경에서 신버전 인스턴스를 구성하기 때문에 실제 서비스 환경에서 신버전을 미리 테스트할 수 있다.</li>\n<li>배포가 완료된 후 남아있는 구버전 환경을 다음 배포에 재사용 할 수 있다.</li>\n<li>신버전 배포가 진행되는 동안 서버 과부화가 일어날 확률이 적다.</li>\n</ul>\n<h2>Canary Release</h2>\n<hr>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/ae694/Untitled_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABwklEQVQoz2WSXU8TQRSG979544X+IxMCoiGyJibQKi0hXKkBL1QimgaRfsG2NtClac1ia2lrarbTXdLtdnbOfB2z25JgfK7OPMk7805mDExgjFFK8V9owv8SAOazgYha4+s3bzc2N+dWKYWIQshMdjv98pVMlnPJGEul0nt7+3fDumHXit9yNAwQEQCEkFLKRr1mlU4gmt1KwQHKhePvVlFwtgj/6PnZj+fpd2c1Z4iIUmlEbF37OwfnmfcVu+MmJ8fS7oy2P1R3Dy9+DW8WYbvtPt05Wsnmype9OCzjhtXWcGnr83Lmi9UcJDvGsmh3l7c+re0eXQ2829qInHPUUTIu0HHViPNA35FxBc0Q5eLOUmsSsGkkuBJTmHLFEZFLPZpEIZMgIYBAKJFImLBJyGdURAEEUgkj70wevmhY7XDK3Y3Ker77FREP6uP7pt3os3HUN09XKr9LiJi/zj0rLXmUdHxnrfSoNbo0Tlr+vSdW2QkC7pqF1eOfOUQ8rLsP1qvNQUTowCysVvtlRDzr5VOn5g31u377efGxM2oaAPyPS4ALpRXxSDgL5+/pkrFMIGNCo/ir0Ih6vqeUEkIQjwDAXyr6G93vIQW6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled_2\"\n        title=\"Untitled_2\"\n        src=\"/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/f058b/Untitled_2.png\"\n        srcset=\"/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/c26ae/Untitled_2.png 158w,\n/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/6bdcf/Untitled_2.png 315w,\n/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/f058b/Untitled_2.png 630w,\n/dev-blog/static/ea85ff4db5cc2698401b8227b5d90cdd/ae694/Untitled_2.png 850w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">카나리아</code> 라는 새는 유독가스에 굉장히 민감한 동물이다. 과거 광부들은 유독가스에 민감한 카나리아 새를 유독가스 누출의 위험을 감지하는 용도로 사용하였다.</p>\n<p>카나리 전략은 위험을 빠르게 감지할 수 있는 배포 전략이다. 신버전의 제공 범위를 늘려가면서 모니터링 및 피드백 과정을 거칠 수 있다. 로드밸런서를 통해 신버전의 제품을 경험하는 사용자를 조절할 수 있는 것이\n특징으로 신버전을 특정 사용자 혹은 단순 비율에 따라 구분해 제공할 수 있다. 이렇게 서버의 트래픽 일부를 신버전으로 분산하여 오류 여부를 확인할 수 있다.</p>\n<h3>장점</h3>\n<ul>\n<li>블루 그린 전략과 마찬가지로 신배포 전에 실제 운영 환경에서 미리 테스트할 수 있다.</li>\n<li>카나리 배포는 단계적인 전환 방식을 통해 부정적 영향을 최소화하고 상황에 따라 트래픽 양을 늘리거나 롤백할 수 있다.</li>\n</ul>\n<h3>단점</h3>\n<ul>\n<li>롤링 전략과 마찬가지로 구버전과 신버전이 모두 운영되기 때문에 버전 관리가 필요하다.</li>\n</ul>\n<h2>사전 준비</h2>\n<hr>\n<h3>전략 구성</h3>\n<p>무중단 배포를 구현하기 위해 위 전략 중 하나를 선택해야 했고 공책 프로젝트에선 블루 그린 전략을 선택했는데 그 이유는 다음과 같다.</p>\n<ol>\n<li>EC2 인스턴스를 여유롭게 사용할 수 있는 환경에선 블루 그린 전략이 적합할 것이라 판단</li>\n<li>사용중인 EC2 인스턴스가 두 개의 스프링 프로젝트를 동시에 구동하기엔 오버헤드가 클 것이라 판단</li>\n</ol>\n<p>블루 그린 전략 중 하나의 EC2 인스턴스 내부에서 두 개의 스프링 프로젝트를 구동하여 포트 스위칭을 통해 블루 그린 전략을 구현하는 방법이 있는데 2번 이유 때문에 EC2 인스턴스를 늘려 IP 스위칭을 통한 블루\n그린 전략을 구현하기로 했다.</p>\n<h3>블루 그린 전략 시나리오</h3>\n<ol>\n<li>인스턴스들을 <code class=\"language-text\">group_a</code> 와 <code class=\"language-text\">group_b</code> 로 구성</li>\n<li>구동중인 <code class=\"language-text\">group</code> 을 확인</li>\n<li><code class=\"language-text\">group_a</code> 가 구동중이라면 <code class=\"language-text\">group_a</code> 는 <code class=\"language-text\">blue</code> 로 <code class=\"language-text\">group_b</code> 는 <code class=\"language-text\">green</code> 으로 설정</li>\n<li><code class=\"language-text\">green</code> 그룹에 신버전 배포 후 실행</li>\n<li><code class=\"language-text\">green</code> 그룹에 대한 Health Check 진행</li>\n<li><code class=\"language-text\">Nginx</code> Reverse Proxy 설정을 <code class=\"language-text\">green</code> 그룹으로 전환</li>\n<li><code class=\"language-text\">blue</code> 그룹 서버를 모두 종료</li>\n</ol>\n<h3>Global properties 설정</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/eac55/Screen_Shot_2022-10-13_at_7.16.20_PM.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.87341772151898%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVQ4y6WUy26DMBBF+f9f67677kigEYkLNsbvW80AwUQoBWrpMBYyl3l5irquUVUVyrKEUgr5Silhz5rPkS2cD2jbFlJKtkTXdSyeH/yLp+DH5xfKy4W9vF6v6Psezjnm6GJBPRgIIdA0DVTfZ38bD8SYENMOQkCMEQU9KFytNQuFEDLiTgK8HtgWznsYayGlgp+E/Er0PatvyEPaUN6sdWOIOwqwBadmFpRK4X5/sCWPnTuI97DOc/gccjrp1Sscci5ILv+XMWSpYIzhPKyqF1/s1ru4VDmGSZBuhRA/Y/7OYt2YQxKkHrTWch+ervKcw9nDhxB8U+aeOowPS1EomWT9tD9DmHgKErPrY5MuzRpTbrP7vXo3VZlUe60xGIO0c1S9o7DO4ft2Aw1ayt+Rwbo1vn4BJIqMNy/ykfYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screen Shot 2022-10-13 at 7.16.20 PM.png\"\n        title=\"Screen Shot 2022-10-13 at 7.16.20 PM.png\"\n        src=\"/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/f058b/Screen_Shot_2022-10-13_at_7.16.20_PM.png\"\n        srcset=\"/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/c26ae/Screen_Shot_2022-10-13_at_7.16.20_PM.png 158w,\n/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/6bdcf/Screen_Shot_2022-10-13_at_7.16.20_PM.png 315w,\n/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/f058b/Screen_Shot_2022-10-13_at_7.16.20_PM.png 630w,\n/dev-blog/static/7c8af764d501a7a98a829895ee1b708c/eac55/Screen_Shot_2022-10-13_at_7.16.20_PM.png 887w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">group_a</code> 와 <code class=\"language-text\">group_b</code> 로 구분할 WAS 의 IP 를 명시해주기 위해 Global properties 를 설정해주어야 한다.</p>\n<p>Manage Jenkins → Configure System → Global properties 에서 설정할 수 있다.</p>\n<p>명시된 IP 들과 SSH 통신이 이루어져야하기 때문에 Publish over SSH 항목에 모두 등록되어 있어야 한다.</p>\n<h2>Pipeline 코드</h2>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">pipeline <span class=\"token punctuation\">{</span>\n    agent any\n\n    stages <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'git clone'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">checkout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">$</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GitSCM'</span><span class=\"token punctuation\">,</span> branches<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">'*/dev'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> extensions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">$</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'SubmoduleOption'</span><span class=\"token punctuation\">,</span> disableSubmodules<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> parentCredentials<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> recursiveSubmodules<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> reference<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> trackingSubmodules<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> userRemoteConfigs<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId<span class=\"token punctuation\">:</span> <span class=\"token string\">'github-webhook-access-token'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">:</span> <span class=\"token string\">'https://github.com/woowacourse-teams/2022-gong-check'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">dir</span><span class=\"token punctuation\">(</span><span class=\"token string\">'backend'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    sh <span class=\"token string\">'''\n                        echo '=== start application bootJar ==='\n                        ./gradlew clean bootJar\n                    '''</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'publish ssh to server'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            environment <span class=\"token punctuation\">{</span>\n                GROUP_GREEN <span class=\"token operator\">=</span> <span class=\"token function\">sh</span><span class=\"token punctuation\">(</span>returnStdout<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> script<span class=\"token punctuation\">:</span> <span class=\"token string\">'''#!/bin/bash\n                    group_a_array=($group_a)\n                    alive_was_count=0\n                    for i in \"${group_a_array[@]}\"\n\t                      do\n\t\t                        if curl -I -X OPTIONS \"http://${i}:8080\"; then\n\t\t\t                          alive_was_count=$((alive_was_count+1))\n\t\t                        fi\n\t                      done\n                    if [ ${alive_was_count} -eq 0 ];then\n                        echo 'group_a'\n                    elif [ ${alive_was_count} -eq ${#group_a_array[@]} ];then\n                        echo 'group_b'\n                    else\n                        echo 'currently runnig was counts are not correct'\n                        exit 100\n                    fi'''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            steps <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">dir</span><span class=\"token punctuation\">(</span><span class=\"token string\">'backend'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    script <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">def</span> green_ips<span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">def</span> blue_ips<span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">def</span> envVar <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">getEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"group_a\"</span></span> <span class=\"token operator\">==</span> GROUP_GREEN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            green_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_a<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            blue_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_b<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                            green_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_b<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            blue_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_a<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                        <span class=\"token keyword\">def</span> green_ips_inline <span class=\"token operator\">=</span> green_ips<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">def</span> map <span class=\"token operator\">=</span> <span class=\"token function\">parseSSHServerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>item <span class=\"token keyword\">in</span> green_ips<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'sh /home/ubuntu/script/server_start.sh'</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/deploy'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs'</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs/*.jar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">}</span>\n\n                        sh <span class=\"token string\">'''#!/bin/bash\n\t\t\t\t\t\t\t\t\t\t\t\t    array=('''</span> <span class=\"token operator\">+</span> green_ips_inline <span class=\"token operator\">+</span> <span class=\"token string\">''')\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t    for ip in \"${array[@]}\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdo\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    url=${array[0]}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    attempts=10\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    timeout=10\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    online=false\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    echo \"Checking status of $url.\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    for (( i=1; i&lt;=$attempts; i++ ))\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    do\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        code=$(curl -sL --connect-timeout 20 --max-time 30 -w \"%{http_code}\\\\n\" \"$url:8080\" -o /dev/null)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        if [ \"$code\" = \"200\" ]; then\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t            online=true\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t            echo \"Connection successful.\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t            break\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        else\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t            sleep $timeout\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t            echo \"Connection failed.\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        fi\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    done\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    if $online; then\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        echo \"Monitor finished, website is online.\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        exit 0 # Build Success\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    else\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        echo \"Monitor failed, website seems to be down.\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t        exit 1 # Build Failed\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t    fi\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdone\n\t\t\t\t\t\t\t\t\t\t\t\t'''</span>\n\n                        <span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> <span class=\"token string\">'gongcheck-reverse-proxy-dev'</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'''#!/bin/bash\n                            function parse_was_address() {\n                                array=('''</span> <span class=\"token operator\">+</span> green_ips_inline <span class=\"token operator\">+</span> <span class=\"token string\">''')\n                                str=\"\"\n                                  for i in \"${array[@]}\"\n                                    do\n                                          str+='set $service_url '\n                                        str+=\"http://${i}:8080;\\n\"\n                                    done\n                                echo -e \"$str\"\n                            }\n                            echo -e \"$(parse_was_address)\" | sudo tee /etc/nginx/conf.d/service-url.inc\n                            sudo service nginx restart\n                            '''</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n                        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>item <span class=\"token keyword\">in</span> blue_ips<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'sh /home/ubuntu/script/kill.sh'</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/deploy'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs'</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs/*.jar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">stage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'clean up workspace'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            steps <span class=\"token punctuation\">{</span>\n                cleanWs deleteDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    post <span class=\"token punctuation\">{</span>\n        success <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">slackSend</span><span class=\"token punctuation\">(</span>channel<span class=\"token punctuation\">:</span> <span class=\"token string\">'jenkins'</span><span class=\"token punctuation\">,</span> color<span class=\"token punctuation\">:</span> <span class=\"token string\">'#00FF00'</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">:</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"SUCCESSFUL: Job '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>JOB_NAME</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> [</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>BUILD_NUMBER</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">]' (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>BUILD_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        failure <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">slackSend</span><span class=\"token punctuation\">(</span>channel<span class=\"token punctuation\">:</span> <span class=\"token string\">'jenkins'</span><span class=\"token punctuation\">,</span> color<span class=\"token punctuation\">:</span> <span class=\"token string\">'#FF0000'</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">:</span> <span class=\"token interpolation-string\"><span class=\"token string\">\"FAILED: Job '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>JOB_NAME</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> [</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>BUILD_NUMBER</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">]' (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">env<span class=\"token punctuation\">.</span>BUILD_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@NonCPS</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">parseSSHServerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> xml <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XmlSlurper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">JENKINS_HOME</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/jenkins.plugins.publish_over_ssh.BapSshPublisherPlugin.xml\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> server_nick_names <span class=\"token operator\">=</span> xml<span class=\"token punctuation\">.</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">.</span>findAll <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'name'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> server_ip_address <span class=\"token operator\">=</span> xml<span class=\"token punctuation\">.</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">.</span>findAll <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'hostname'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> server_nick_names<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">def</span> server_ip_str <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span> server_ip_address<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">def</span> server_nick_name_str <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span> server_nick_names<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>server_ip_str<span class=\"token punctuation\">,</span> server_nick_name_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> map<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>블루 그린 그룹 구분</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">environment <span class=\"token punctuation\">{</span>\n    GROUP_GREEN <span class=\"token operator\">=</span> <span class=\"token function\">sh</span><span class=\"token punctuation\">(</span>returnStdout<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> script<span class=\"token punctuation\">:</span> <span class=\"token string\">'''#!/bin/bash\n        group_a_array=($group_a)\n        alive_was_count=0\n        for i in \"${group_a_array[@]}\"\n            do\n                if curl -I -X OPTIONS \"http://${i}:8080\"; then\n                    alive_was_count=$((alive_was_count+1))\n                fi\n            done\n        if [ ${alive_was_count} -eq 0 ];then\n            echo 'group_a'\n        elif [ ${alive_was_count} -eq ${#group_a_array[@]} ];then\n            echo 'group_b'\n        else\n            echo 'currently runnig was counts are not correct'\n            exit 100\n        fi'''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Global properties 설정을 통해 <code class=\"language-text\">group_a</code> <code class=\"language-text\">group_b</code> 변수를 사용할 수 있다. <code class=\"language-text\">group_a</code> 배열을 순회하면서 <code class=\"language-text\">OPTIONS</code> 요청을 보내 해당 그룹에 속한 서버들이 구동중인지 확인할\n수 있다.</p>\n<p><code class=\"language-text\">environment</code> 블럭을 통해 쉘 스크립트에서 반환한 값을 환경 변수에 담아서 외부 Groovy 스크립트에서 사용할 수 있다.</p>\n<p><code class=\"language-text\">group_a</code> 에 속한 서버들이 구동중이라면 <code class=\"language-text\">GROUP_GREEN</code> 에는 <code class=\"language-text\">group_a</code> 라는 문자열이 저장된다.</p>\n<h3>그룹별 IP 배열 생성</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">def</span> green_ips<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">def</span> blue_ips<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">def</span> envVar <span class=\"token operator\">=</span> env<span class=\"token punctuation\">.</span><span class=\"token function\">getEnvironment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"group_a\"</span></span> <span class=\"token operator\">==</span> GROUP_GREEN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    green_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_a<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blue_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_b<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    green_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_b<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    blue_ips <span class=\"token operator\">=</span> envVar<span class=\"token punctuation\">.</span>group_a<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">env.getEnvironment()</code> 메서드를 통해 Global properties 에서 선언한 환경 변수를 Groovy 스크립트에서 사용할 수 있다.</p>\n<p><code class=\"language-text\">environment</code> 블럭에서 선언한 <code class=\"language-text\">GROUP_GREEN</code> 을 통해 <code class=\"language-text\">green_ips</code> 와 <code class=\"language-text\">blue_ips</code> 를 구분한다.</p>\n<p><code class=\"language-text\">group_a</code> 가 <code class=\"language-text\">green</code> 이라면 <code class=\"language-text\">green_ips</code> 에는 <code class=\"language-text\">192.168.1.199</code> 가 할당되었을 것이다.</p>\n<h3>IP 에 해당하는 SSH Server Name Map 생성</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token annotation punctuation\">@NonCPS</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">parseSSHServerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> xml <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XmlSlurper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">JENKINS_HOME</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/jenkins.plugins.publish_over_ssh.BapSshPublisherPlugin.xml\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> server_nick_names <span class=\"token operator\">=</span> xml<span class=\"token punctuation\">.</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">.</span>findAll <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'name'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> server_ip_address <span class=\"token operator\">=</span> xml<span class=\"token punctuation\">.</span><span class=\"token string\">'**'</span><span class=\"token punctuation\">.</span>findAll <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'hostname'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">def</span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> server_nick_names<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">def</span> server_ip_str <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span> server_ip_address<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">def</span> server_nick_name_str <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span> server_nick_names<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        map<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>server_ip_str<span class=\"token punctuation\">,</span> server_nick_name_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> map<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Jenkins 의 <code class=\"language-text\">sshPublisher</code> 는 IP 가 아닌 SSH Server Name 으로 작업을 수행하기 때문에 IP 에 해당하는 SSH Server Name 을 알아내야 한다.</p>\n<p>Jenkins 는 Publish over SSH 항목에서 설정했던 SSH Server Name 과 IP 등의\n정보를 <code class=\"language-text\">${JENKINS_HOME}/jenkins.plugins.publish_over_ssh.BapSshPublisherPlugin.xml</code> 에 저장한다.</p>\n<p>위 파일을 파싱하여 IP 와 SSH Server Name 이 <code class=\"language-text\">key-value</code> 형태로 이루어진 Map 을 생성해 스크립트에서 활용할 필요가 있다.</p>\n<p>Jenkins 는 기본적으로 작업 중지 및 재개 등을 위해 스크립트의 <code class=\"language-text\">step</code> 별 상태를 직렬화하여 저장하는데, XML 파싱 관련 객체들은 직렬화가 불가능하여 에러가 발생한다.</p>\n<p>때문에 XML 파싱 관련 로직을 별도의 메서드로 분리하여 <code class=\"language-text\">@NonCPS</code> 애너테이션을 통해 직렬화 및 저장 대상에서 제외시킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token punctuation\">{</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">218</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> frontend <span class=\"token operator\">-</span> dev <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">247</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> frontend <span class=\"token operator\">-</span> prod <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">220</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> image <span class=\"token operator\">-</span> prod <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">199</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> backend <span class=\"token operator\">-</span> dev <span class=\"token operator\">-</span> a <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">234</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> backend <span class=\"token operator\">-</span> dev <span class=\"token operator\">-</span> b <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">201</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> backend <span class=\"token operator\">-</span> prod <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">212</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> image <span class=\"token operator\">-</span> dev <span class=\"token punctuation\">,</span>\n    <span class=\"token number\">192.168</span> <span class=\"token punctuation\">.</span><span class=\"token number\">1</span> <span class=\"token punctuation\">.</span><span class=\"token number\">240</span> <span class=\"token operator\">=</span> gongcheck <span class=\"token operator\">-</span> reverse <span class=\"token operator\">-</span> proxy <span class=\"token operator\">-</span> dev\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>파싱된 Map 을 확인해보면 위와 같이 IP 에 해당하는 SSH Server Name 을 가져올 수 있도록 생성되어 있다.</p>\n<h3>Green 그룹 배포 및 WAS 실행</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>item <span class=\"token keyword\">in</span> green_ips<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'sh /home/ubuntu/script/server_start.sh'</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/deploy'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs'</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs/*.jar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">green_ips</code> 배열을 순회하면서 <code class=\"language-text\">map.get(item)</code> 을 통해 IP 에 해당하는 SSH Server Name 을 통해 <code class=\"language-text\">sshPublisher</code> 를 실행할 수 있다.</p>\n<p><code class=\"language-text\">green_ips</code> 에 <code class=\"language-text\">192.168.1.199</code> 가 들어있다면, <code class=\"language-text\">map.get(item)</code> 을 통해 <code class=\"language-text\">gongcheck-backend-dev-a</code> 에 해당하는 WAS 로 <code class=\"language-text\">sshPublisher</code> 를 실행할\n것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 진행중인 application pid 조회\"</span>\n<span class=\"token assign-left variable\">CURRENT_PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> java <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> jar <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">nohup</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> gong-check <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 진행중인 application pid : <span class=\"token variable\">$CURRENT_PID</span>\"</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -z <span class=\"token variable\">${CURRENT_PID}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 구동중인 어플리케이션이 없으므로 종료하지 않습니다.\"</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> sudo kill -9 <span class=\"token variable\">$CURRENT_PID</span>\"</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">kill</span> -9 <span class=\"token variable\">${CURRENT_PID}</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">lsof</span> -i:8080\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 어플리케이션 정상 종료 완료\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 어플리케이션 배포 시작\"</span>\n<span class=\"token assign-left variable\">JAR_PATH</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> -t /home/ubuntu/deploy/*.jar <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -1<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">BUILD_ID</span><span class=\"token operator\">=</span>dontKillMe <span class=\"token function\">sudo</span> <span class=\"token function\">nohup</span> java -jar <span class=\"token variable\">${JAR_PATH}</span> --spring.profiles.active<span class=\"token operator\">=</span>dev  <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>>></span> /dev/null <span class=\"token operator\">>></span> /dev/null <span class=\"token operator\">&amp;</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 어플리케이션 배포 종료\"</span></code></pre></div>\n<p><code class=\"language-text\">sshPublisher</code> 는 인스턴스 내부에 있는 <code class=\"language-text\">server_start.sh</code> 를 실행시키는데, 이는 위와 같다.</p>\n<h3>Green 그룹 Health Check</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">sh <span class=\"token string\">'''#!/bin/bash\n    array=('''</span> <span class=\"token operator\">+</span> green_ips_inline <span class=\"token operator\">+</span> <span class=\"token string\">''')\n\n    for ip in \"${array[@]}\"\n\t\t\t\tdo\n\t\t\t\t    url=${array[0]}\n\t\t\t\t    attempts=10\n\t\t\t\t    timeout=10\n\t\t\t\t    online=false\n\t\t\t\t\n\t\t\t\t    echo \"Checking status of $url.\"\n\t\t\t\t\n\t\t\t\t    for (( i=1; i&lt;=$attempts; i++ ))\n\t\t\t\t\t\t    do\n\t\t\t\t\t\t        code=$(curl -sL --connect-timeout 20 --max-time 30 -w \"%{http_code}\\\\n\" \"$url:8080\" -o /dev/null)\n\t\t\t\t\t\t\n\t\t\t\t\t\t        if [ \"$code\" = \"200\" ]; then\n\t\t\t\t\t\t            online=true\n\t\t\t\t\t\t            echo \"Connection successful.\"\n\t\t\t\t\t\t            break\n\t\t\t\t\t\t        else\n\t\t\t\t\t\t            sleep $timeout\n\t\t\t\t\t\t            echo \"Connection failed.\"\n\t\t\t\t\t\t        fi\n\t\t\t\t\t\t    done\n\t\t\t\t\n\t\t\t\t    if $online; then\n\t\t\t\t        echo \"Monitor finished, website is online.\"\n\t\t\t\t        exit 0 # Build Success\n\t\t\t\t    else\n\t\t\t\t        echo \"Monitor failed, website seems to be down.\"\n\t\t\t\t        exit 1 # Build Failed\n\t\t\t\t    fi\n\t\t\t\tdone\n'''</span></code></pre></div>\n<p>쉘 스크립트를 통해 <code class=\"language-text\">green</code> 그룹에 대한 Health Check 를 진행한다. <code class=\"language-text\">curl</code> 요청을 통해 해당 IP 의 8080번 포트가 열려있는지 확인한다. 10번의 시도 간 서버가 응답하지 못한다면 서버\n배포에 실패했다고 판단하고 스크립트를 종료한다.</p>\n<h3>Nginx 설정 변경</h3>\n<p><code class=\"language-text\">green</code> 에 해당하는 WAS 가 준비가 되어 있으니 <code class=\"language-text\">Nginx</code> 에서 요청을 <code class=\"language-text\">green</code> 으로 보낼 수 있도록 설정을 변경해주어야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">server <span class=\"token punctuation\">{</span>\n\tserver_name dev.gongcheck.shop<span class=\"token punctuation\">;</span>\n\n\tinclude /etc/nginx/conf.d/service-url.inc<span class=\"token punctuation\">;</span>\n\n\tlocation / <span class=\"token punctuation\">{</span>\n\t\tproxy_pass <span class=\"token variable\">$service_url</span>/index.html<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>현재 <code class=\"language-text\">Nginx</code> 에선 <code class=\"language-text\">proxy_pass</code> 에 <code class=\"language-text\">service_url</code> 이라는 변수를 할당하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> <span class=\"token string\">'gongcheck-reverse-proxy-dev'</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'''#!/bin/bash\n    function parse_was_address() {\n        array=('''</span> <span class=\"token operator\">+</span> green_ips_inline <span class=\"token operator\">+</span> <span class=\"token string\">''')\n        str=\"\"\n          for i in \"${array[@]}\"\n            do\n                str+='set $service_url '\n                str+=\"http://${i}:8080;\\n\"\n            done\n        echo -e \"$str\"\n    }\n    echo -e \"$(parse_was_address)\" | sudo tee /etc/nginx/conf.d/service-url.inc\n    sudo service nginx restart\n    '''</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>해당 변수는 <code class=\"language-text\">service-url.inc</code> 를 통해 선언되고 있기에 이를 수정하는 쉘 스크립트를 <code class=\"language-text\">sshPublisher</code> 를 통해 수행한다. <code class=\"language-text\">tee</code> 명령어를 통해 해당 파일을 덮어씌우거나 새로 생성할 수\n있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$service_url</span> http://192.168.1.199:8080<span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">green_ips_inline</code> 에 <code class=\"language-text\">192.168.1.199</code> 만 존재한다면, <code class=\"language-text\">service-url.inc</code> 파일에는 위와 같은 스크립트가 작성되어 있을 것이다.</p>\n<h3>Blue 그룹 WAS 종료</h3>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>item <span class=\"token keyword\">in</span> blue_ips<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">sshPublisher</span><span class=\"token punctuation\">(</span>publishers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshPublisherDesc</span><span class=\"token punctuation\">(</span>configName<span class=\"token punctuation\">:</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> transfers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">sshTransfer</span><span class=\"token punctuation\">(</span>cleanRemote<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> excludes<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> execCommand<span class=\"token punctuation\">:</span> <span class=\"token string\">'sh /home/ubuntu/script/kill.sh'</span><span class=\"token punctuation\">,</span> execTimeout<span class=\"token punctuation\">:</span> <span class=\"token number\">120000</span><span class=\"token punctuation\">,</span> flatten<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> makeEmptyDirs<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> noDefaultExcludes<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> patternSeparator<span class=\"token punctuation\">:</span> <span class=\"token string\">'[, ]+'</span><span class=\"token punctuation\">,</span> remoteDirectory<span class=\"token punctuation\">:</span> <span class=\"token string\">'/deploy'</span><span class=\"token punctuation\">,</span> remoteDirectorySDF<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> removePrefix<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs'</span><span class=\"token punctuation\">,</span> sourceFiles<span class=\"token punctuation\">:</span> <span class=\"token string\">'build/libs/*.jar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> usePromotionTimestamp<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> useWorkspaceInPromotion<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> verbose<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">blue_ips</code> 배열을 순회하면서 <code class=\"language-text\">map.get(item)</code> 을 통해 IP 에 해당하는 SSH Server Name 을 통해 <code class=\"language-text\">sshPublisher</code> 를 실행할 수 있다.</p>\n<p><code class=\"language-text\">blue_ips</code> 에 <code class=\"language-text\">192.168.1.234</code> 가 들어있다면, <code class=\"language-text\">map.get(item)</code> 을 통해 <code class=\"language-text\">gongcheck-backend-dev-b</code> 에 해당하는 WAS 로 <code class=\"language-text\">sshPublisher</code> 를 실행할\n것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 진행중인 application pid 조회\"</span>\n<span class=\"token assign-left variable\">CURRENT_PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> -ef <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> java <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> jar <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -v <span class=\"token function\">nohup</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> gong-check <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 진행중인 application pid : <span class=\"token variable\">$CURRENT_PID</span>\"</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> -z <span class=\"token variable\">${CURRENT_PID}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 구동중인 어플리케이션이 없으므로 종료하지 않습니다.\"</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> sudo kill -9 <span class=\"token variable\">$CURRENT_PID</span>\"</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">kill</span> -9 <span class=\"token variable\">${CURRENT_PID}</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">lsof</span> -i:8080\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 어플리케이션 정상 종료 완료\"</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p><code class=\"language-text\">sshPublisher</code> 는 인스턴스 내부에 있는 <code class=\"language-text\">kill.sh</code> 를 실행시키는데, 이는 위와 같다.</p>\n<h2>개선 사항</h2>\n<hr>\n<p>추후 WAS 를 다중화한다면 로드 밸런싱을 적용해야하기 때문에 <code class=\"language-text\">Nginx</code> 설정을 변경하는 스크립트를 수정해주어야 한다. 로드 밸런싱 설정 적용은 크게 어렵지 않기 때문에 추후에 서비스가 WAS 다중화를 요구한다면\n그때 수정해주어도 무방하다.</p>\n<p>추가로 <code class=\"language-text\">blue</code> 그룹에 해당하는 EC2 인스턴스가 <code class=\"language-text\">idle</code> 상태로 대기하고 있기 때문에 불필요한 비용이 발생하고 있는 것을 알 수 있다. 때문에 배포가 이루어질 때 마다 EC2 인스턴스를 자동으로 생성 및\n제거해주는 방식을 고려해 볼 필요가 있다.</p>\n<h2>References</h2>\n<hr>\n<ul>\n<li><a href=\"https://loosie.tistory.com/781\">https://loosie.tistory.com/781</a></li>\n<li><a href=\"https://xlffm3.github.io/devops/mock-blue-green-cd/\">https://xlffm3.github.io/devops/mock-blue-green-cd/</a></li>\n<li><a href=\"https://jiyeonseo.github.io/2020/03/19/jenkins-health-check/\">https://jiyeonseo.github.io/2020/03/19/jenkins-health-check/</a></li>\n</ul>","fields":{"slug":"/BE/쿼리치/nonstop-deployment/nonstop-deployment/"},"frontmatter":{"title":"Jenkins 무중단 배포","date":"2022.10.13","description":"Jenkins 에서 Blue-Green 무중단 배포 구현하기","tags":["backend","Jenkins"]}}},"pageContext":{"id":"70417758-545e-518c-9cf1-5bb8c7cfbcdd","previousPostId":"2bec97ad-be32-5659-9e0b-e0230a245c9f","nextPostId":"5622dc46-4775-5982-a185-04e87e1ca5e6"}},"staticQueryHashes":["2841359383"]}