{"componentChunkName":"component---src-templates-blog-post-js","path":"/BE/어썸오/sse/sse/","result":{"data":{"site":{"siteMetadata":{"title":"공책 팀 개발 블로그"}},"markdownRemark":{"id":"be2a70d3-e2c8-563c-be43-005450c9ef90","excerpt":"안녕하세요. 공책 팀의 어썸오입니다. 저희 서비스는 여러 사람이 하나의 체크리스트를 동시에 사용할 수 있어야합니다. 아래처럼요. 내가 보낸 요청(체크리스트 상태 변경)이 아니라도 현재 체크리스트의 상태 데이터를 서버로부터 전달받아야 합니다. 전통적인 Client-Server…","html":"<p>안녕하세요. 공책 팀의 어썸오입니다.</p>\n<p>저희 서비스는 여러 사람이 하나의 체크리스트를 동시에 사용할 수 있어야합니다. 아래처럼요.</p>\n<img src=\"/dev-blog/c6ed615dd12c22bcfaf4dc409fcfed6c/checklist.gif\" width=\"630\">\n<p>내가 보낸 요청(체크리스트 상태 변경)이 아니라도 현재 체크리스트의 상태 데이터를 서버로부터 전달받아야 합니다.</p>\n<p>전통적인 Client-Server 모델의 HTTP 통신에서는 이런 기능을 구현하기가 조금 난감합니다. 클라이언트의 요청이 있어야만 서버가 응답을 할 수 있기 때문이죠.</p>\n<p>HTTP를 기반으로 이 문제를 해결하려면 세 가지 방법을 고려해볼 수 있습니다.</p>\n<h3>Short Polling</h3>\n<p>클라이언트가 주기적으로 서버로 요청을 보내는 방식입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/fd0d860cab587b024f564f210056b29b/2eb79/polling.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAACg0lEQVQ4y41Vi3IaMQzk/z8RaBpSIKRN4fyW/NqOdA8I0Gk9s9zZ2GtptfatSikQSOu9475/3+axWiuYGa01HZv7K1nsnMPLywv2+z1SSsg5L4ufQZrMEYLdbof1eo3j8ahjK/mJMWKz2WC73YKIdOK/IpR1gsPhgP3+gPP5fCWUcAWtybMo5lZbR4gVPsp/1w16ayqNzBWOWa7VPMFaC+cScgGIGxKJJg3WFby9E9avAcYVcO5I3HRObUBMjJjSstFqDn8wBpwLJIamWo1PbUxAyeiSCWdUyYozChXYwSOGuMihhLLQDBews7q4pYSeElqK6ESolzO6NeiZ0YgWQArjHVK8IZxFpkQIIaGUjpyropSGGAs+PhnHD0Kk9lCkXIo640uE8jIMA0Jk5AqwkApqV82Mqzh9shJKn3JbdDSW4P1dylIdISwli2PRpWqimfixtTFlZ7SyLecRNEpD1iI495hy8B5kzCj+THgD1LJsIoR9spbYLYTwREMSDUltI2kJJGUbKr7vEzavET6Nc/sN5Oh576feZBvZRXyYqKBUjPrlBuYKpgyiAjMkhIuHPzstVEwVKVV9GuOUUGK7+vByQZHyZ9Z06nABve1Au1fw+zvo2xZ02INPJ7QY0fhqH2fMciSXlGMIYNFCjmAeTSxAb0s6YxQTVLNxVC6XB0I97Mu1JWYfJ4s1fv5mfPwitQoeVAT8M0IRNsQ8+mzymEAuhs+h4MeJ4HwBqQ+/wtgbQj2qzLDGoEqEGl67Qj3lABqt0Tgjhwj2V9jBQEWYi9KnsNk5Fbmm9AXFWhTr9L0xT/qW0Yu1wln7mLJEOWv4v20u1dOiLNf7X679v34O7j4NfwBaunDO4rHyFgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"polling\"\n        title=\"polling\"\n        src=\"/dev-blog/static/fd0d860cab587b024f564f210056b29b/f058b/polling.png\"\n        srcset=\"/dev-blog/static/fd0d860cab587b024f564f210056b29b/c26ae/polling.png 158w,\n/dev-blog/static/fd0d860cab587b024f564f210056b29b/6bdcf/polling.png 315w,\n/dev-blog/static/fd0d860cab587b024f564f210056b29b/f058b/polling.png 630w,\n/dev-blog/static/fd0d860cab587b024f564f210056b29b/40601/polling.png 945w,\n/dev-blog/static/fd0d860cab587b024f564f210056b29b/2eb79/polling.png 1256w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>클라이언트와 서버 모두 구현이 단순하다는 것이 특징입니다. 서버가 요청에 대한 부담이 크지 않고 요청 주기를 넉넉하게 잡아도 될 정도로 실시간성이 중요하지 않다면 고려해 볼 만한 것 같습니다.</p>\n<h3>Long Polling</h3>\n<p>한번 요청을 보내고 일정 시간동안 서버의 응답을 기다리는 방식입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/e4611/longpolling.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.63291139240506%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7klEQVQ4y4VU7ZLiIBD0/R/Qn+qVlfNKy10TEr4G6K0G4YjZXadqxADTM0M37GKMcM6BY0oJ3nuICGj8plfrvxnDvYwLITSMHX+MMTgejzidTpjnOQPWwB6kH7lnmibs93scDgdorQsg0Ql4uVzyAv8zcwXaOlonSikMw4D7/Z7jWoXMRmB6beGdMYZ76xExhol2dUPOOLO6BOti9hASjA34M2icLwbORUhguxH1aFkZ261HsavnQkBrbVuIkW3F7DWBe36XuZDnlDIYx0cjsgFyogfcWno6VnsYQ4aXZVkDvlb4KpkVbLfGGMZSHWtAVuhcC6oWnUPQGjJN8B8fSJ1Gqx7HcczjtsJlBsg0ZSMeKQT46xXhfoPcrrDDgLDoksRaJOeglWrVbUiZJ4UoAVE8IsUtAvGCaRZo/718nLNNZmtA8dDGwgcUVj1ZTdAm4t/N4vxXY9ECL4XtzLgkzLPJN6baqkLXs/wNKVlKEot7XoiERdvMcNXiryxvGU8vfJeWKbl29X4C/EmPdSq1M/SZ4Rq7Bqyy6SqUz88sF7o5n7OESFZRgsBqnWVTiVkBGqWQ+MZZW9w5yOORQWUcs2cgSot6jDEDuq6QNSCvz/OhfWf/W3arB/nt1fvN+6u3ASwvTHxLyuvjELuOCPgFc48oHu/ifkAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"long_polling\"\n        title=\"long_polling\"\n        src=\"/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/f058b/longpolling.png\"\n        srcset=\"/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/c26ae/longpolling.png 158w,\n/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/6bdcf/longpolling.png 315w,\n/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/f058b/longpolling.png 630w,\n/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/40601/longpolling.png 945w,\n/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/78612/longpolling.png 1260w,\n/dev-blog/static/7e3a34a031897051c1c0e96ca2843ef4/e4611/longpolling.png 1298w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>실시간 메시지 전달이 중요하지만 서버의 상태가 빈번하게 변하지 않는 경우에 적합합니다. 서버로부터 응답을 받고 나면 다시 연결 요청을 하기 때문에, 상태가 빈번하게 바뀐다면 연결 요청도 늘어나게 됩니다.</p>\n<h3>Server-Sent Events(SSE)</h3>\n<p>서버와 한번 연결을 맺고나면 일정 시간동안 서버에서 변경이 발생할 때마다 데이터를 전송받는 방법입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/78612/sse.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB3klEQVQ4y41V2W7CMBDM//8Z77xBlVbqhQSEEt+xPdVsEuoE03allVnbmZ09vDQpJeScQeFa/l5LeVZ+R5ntxloLYwy01nDOif4FGGOUe0opdF2H6/UqNvcb7z32+z02mw3O5/PN04w3sy7ZhxBkbdsW2+0Wu90OwzCMgEQmQ6V6eO9EJ6Q7lmuGBCah2SaZhpe4qbVBjEk0pR8wHxKsi4jpHjznJEQIRKU0o8cBvTIIgeAJblKCHY4O+2eNUxdu4FzpNMYsuS+dCCDjZ3HWDEpWYscsQEPM4tDYiGuvF7lu5pzMgHmVu0VBKpVn/sv7DwFrbbOIYFICSgFLQCZ0HbJ8xFZQCtEYhOMR4XQancWIzPZKCUbrRQfcAHlAgMTyU0PA0HVwb28C5j8+MHx9yb6cey+r7vsKYM7Ql4tcmj2TxX/EWHufQ27Y6cktQmZ/WTuyslbCL8/otBoyDQmZuSl0uFxg2xb+cIB5eoJ7f/8Jmco5UAuZhmZ+5otTDqsDYnI2CyOrhuwqIdfA1mIf5bAcW8KCL6Pv4V5fpcr25QX+83PMa1Hl+5CnppQqlyFzihgjoNKLSsk+W+vWCY/6cFGUaWr8V6pPTwD5hFAfqr+pfsRwnsJ//a+shZOqlG/BJXgnZOcigQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sse\"\n        title=\"sse\"\n        src=\"/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/f058b/sse.png\"\n        srcset=\"/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/c26ae/sse.png 158w,\n/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/6bdcf/sse.png 315w,\n/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/f058b/sse.png 630w,\n/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/40601/sse.png 945w,\n/dev-blog/static/e9061ada0ae476d3fd73f9271d6d585d/78612/sse.png 1260w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>응답마다 다시 요청을 해야하는 Long polling 방식보다 효율적입니다(물론 상황에 따라 달라질 수 있습니다).\nSSE는 서버에서 클라이언트로 text message를 보내는 브라우저 기반 웹 애플리케이션 기술입니다. SSE는 HTTP의 persistent connections을 기반으로하는 표준 기술입니다.</p>\n<p>이 외에도 웹소켓을 이용해 서버와 양방향 통신을 하는 방법이 있습니다. 서비스 상황에 맞게 적절한 방법을 선택하면 됩니다.</p>\n<p>저희 팀은 처음에는 구현이 간단한 short polling 방식을 사용했으나, 사용자에게 높은 실시간성을 제공하기 위해 0.1초마다 서버에 요청을 보내다보니 서버에도 부담이 크고, 변경 사항이 없는데도 DOM을 계속 갈아끼우는 문제가 있기 때문에 SSE 방식으로 변경하기로 결정했습니다.</p>\n<p>사실 저희 서비스의 특성 상 SSE보다는 WebSocket이 더 적절하다는 논의가 있었으나, 지금 당장은 새로운 라이브러리 추가나 프로토콜 학습 없이 바로 적용할 수 있는 SSE를 적용하기로 했습니다.</p>\n<h2>개요</h2>\n<p>SSE를 이용하는 통신의 개요는 다음과 같습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/aea0a/sse2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.45569620253164%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcklEQVQ4y41TWa6DMAzk/qfsV6EsZcnqbPNkI9pAW+lFMgbi2OPxpCmlgFfOGd57OOcQQgD/563d78aL9zjm+D78sZp6Y1kW3G43EPmPQGD/nqYJ9/tdANSFjvdXQu0NFjujX1tYcsi5gGKBowJLBSm9D3KyU6mqeHNFoa2Vw5zQGcI8KEyPDUYTYgK8i9BKQymFdV2htTkjZN6WdZUAtSl4Y4EYUEJAHAfER7f75xPZOeQYhUPvSSgyxpw5TCnBWott28S8cy/GcghIziMqjUzEMJBLkeHxOUbEvrZLywDxBDk4ZyRjEOYZgdERocQoRbjwo+8xjiOGYZDW+76XQk0tCyabvGcNScKa9FpeLJ1fq7kGnxBqjTCOoK5DslbQMVJGxNJhVG3bYp5ndF0n3Db12PkZuDVOGONuF4n8C6EEEgkimiZp+aqzby3XdH0Im2WSvAcpJdMsl0SH50kST/zLtXsJu245/bijdeLjpnxL+AeaBf8RD0Sy4QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sse2\"\n        title=\"sse2\"\n        src=\"/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/f058b/sse2.png\"\n        srcset=\"/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/c26ae/sse2.png 158w,\n/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/6bdcf/sse2.png 315w,\n/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/f058b/sse2.png 630w,\n/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/40601/sse2.png 945w,\n/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/78612/sse2.png 1260w,\n/dev-blog/static/c9d3a25dbd760dd65d96cdb48af73160/aea0a/sse2.png 2018w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Client: SSE Subscribe 요청</h3>\n<p>우선 클라이언트에서 서버의 이벤트를 구독하기 위한 요청을 보내야합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token request-line\"><span class=\"token method property\">GET</span> <span class=\"token request-target url\">/connect</span> <span class=\"token http-version property\">HTTP/1.1</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Accept</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">text/event-stream</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Cache-Control</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">no-cache</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Connection</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">keep-alive</span></span></code></pre></div>\n<p>이벤트의 미디어 타입은 <code class=\"language-text\">text/event-stream</code>이 표준으로 정해져있습니다. 이벤트는 캐싱하지 않으며 지속적 연결을 사용해야합니다.</p>\n<h3>Server: Subscription에 대한 응답</h3>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\">HTTP/1.1 200\n<span class=\"token header\"><span class=\"token header-name keyword\">Content-Type</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">text/event-stream;charset=UTF-8</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">Transfer-Encoding</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">chunked</span></span></code></pre></div>\n<p>응답의 미디어 타입은 <code class=\"language-text\">text/event-stream</code> 입니다. 이때 <code class=\"language-text\">Transfer-Encoding</code> 헤더의 값을 <code class=\"language-text\">chuncked</code>로 설정합니다. 서버는 동적으로 생성된 컨텐츠를 스트리밍하기 때문에 본문의 크기를 미리 알 수 없기 때문입니다.</p>\n<h3>Server: 이벤트 전달</h3>\n<p>클라이언트에서 subscribe를 하고나면 서버는 해당 클라이언트에게 비동기적으로 데이터를 전송할 수 있습니다. 이때 데이터는 <code class=\"language-text\">UTF-8</code>로 인코딩된 텍스트 데이터만 가능합니다(바이너리 데이터는 전송 불가능).</p>\n<p>서로 다른 이벤트는 줄바꿈 문자 두개(\\n\\n)로 구분되며 각각의 이벤트는 한 개 이상의 <code class=\"language-text\">name: value</code> 필드로 구성되며 이들은 줄바꿈 문자 하나로 구분됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token header\"><span class=\"token header-name keyword\">event</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">type1</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">data</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">An event of type1.</span></span>\n\n<span class=\"token header\"><span class=\"token header-name keyword\">event</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">type2</span></span>\n<span class=\"token header\"><span class=\"token header-name keyword\">data</span><span class=\"token punctuation\">:</span> <span class=\"token header-value\">An event of type2.</span></span></code></pre></div>\n<h2>코드로 살펴봅시다</h2>\n<p>사용된 예시 코드는 <a href=\"https://github.com/awesomeo184/sse-sample\">여기</a>서 확인하실 수 있습니다.</p>\n<p>기본적인 흐름을 먼저 설명하자면,</p>\n<ol>\n<li>클라이언트에서 SSE 연결 요청을 보낸다.</li>\n<li>서버에서는 요청한 브라우저에 해당하는 SSE 통신 객체를 만든다.</li>\n<li>향후 서버에서 이벤트가 발생하면 해당 객체를 통해 클라이언트로 데이터를 전달한다.</li>\n</ol>\n<p>그림으로 보면 다음과 같습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/a88f6/sse3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.22784810126582%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABMklEQVQoz6WTjW6DMAyEef83LOooggJhhdKOfyj19FkyoqjTNO0ki8TY57OTeM/nUzBg663vLyDHG8dRuq57G9C2rfi+L9frVffLsvxoJsDr+14TQV3XUlWVPB4P3VPodrsJMSThx+Z5lmmaXowYJbSfVGiaRpxzEkWREqEeQAI5SXyJ3wO/tgwJylBggAi/KS+KQk6nk8RxLIfDQfI8Vz/ECLLxqMI0TSXLslXN9jAsiC+KIQYUO5/PMgyD5pGzEr47DFqzNi34UhQ6X/BV1/J5KdbYF0Kq0DK43+9aGdWosNNnHYahJEmi+8w5OR4/tKh1ZsTedtC0RCW7BhbEf4pgrHPnJAgCjbX49ZTtHu3nB7bXw9Ykooq9zdBMCVFFZavw75fC3MqyfHvK+6f4m6HwG4++qtCTGsIEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sse3\"\n        title=\"sse3\"\n        src=\"/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/f058b/sse3.png\"\n        srcset=\"/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/c26ae/sse3.png 158w,\n/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/6bdcf/sse3.png 315w,\n/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/f058b/sse3.png 630w,\n/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/40601/sse3.png 945w,\n/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/78612/sse3.png 1260w,\n/dev-blog/static/07d241cd25a664abebd2e6ce4154af70/a88f6/sse3.png 1900w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/0faf1/sse4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABKElEQVQoz41Ti46EIAzc//9GExMXfBxqfCCKqN1Mb0vUvVy2SRXpMJ22+CAi2vedjuMgMazFt227xP4z4B5YjONI3vu4KQayNE1JKUXrujIGjnUIITpwEAVjQmstBwBsmobyPKdlWRg0z3MkQOKyLCnLMk7inIvnRBATYkMy4I0EbdsyGIoBLquKjDFUVRXH76WCgwkB1lozwb1kgFAOVNZ1zZgkSVjh7FxswYUQitw7eDYpA4S/vtPiPVk70o8xNL5VojUXQjxwUMrruo77BJ+mKRIqrUkpzYeMqSl7PiPRB2Hf95xpGAbuE96iWiZZFAUPAhUhGaa/hvBZsigEEJuYJA6iX9hDovNVwfd5Ld+REOVAFa6LTFSC317oy8W+E/71t3zrUPgCcjdcK60psBwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sse4\"\n        title=\"sse4\"\n        src=\"/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/f058b/sse4.png\"\n        srcset=\"/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/c26ae/sse4.png 158w,\n/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/6bdcf/sse4.png 315w,\n/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/f058b/sse4.png 630w,\n/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/40601/sse4.png 945w,\n/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/78612/sse4.png 1260w,\n/dev-blog/static/cda947189eb317f424fdbcae6a969fe9/0faf1/sse4.png 1956w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>우선 클라이언트에서는 <code class=\"language-text\">EventSource</code>라는 인터페이스로 SSE 연결 요청을 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> sse <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EventSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080/connect\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>spring framework 4.2부터 SSE 통신을 지원하는 <code class=\"language-text\">SseEmitter</code> API를 제공합니다. 이를 이용해 SSE 구독 요청에 대한 응답을 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span>extern<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Slf4j</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">MediaType</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>http<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ResponseEntity</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">GetMapping</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">RestController</span></span><span class=\"token punctuation\">;</span>  \n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>web<span class=\"token punctuation\">.</span>servlet<span class=\"token punctuation\">.</span>mvc<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SseEmitter</span></span><span class=\"token punctuation\">;</span>  \n  \n<span class=\"token annotation punctuation\">@RestController</span>  \n<span class=\"token annotation punctuation\">@Slf4j</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SseController</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SseEmitters</span> sseEmitters<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SseController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitters</span> sseEmitters<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sseEmitters <span class=\"token operator\">=</span> sseEmitters<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"/connect\"</span><span class=\"token punctuation\">,</span> produces <span class=\"token operator\">=</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span>TEXT_EVENT_STREAM_VALUE<span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">SseEmitter</span> emitter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        sseEmitters<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            emitter<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">.</span><span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n                    <span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connect\"</span><span class=\"token punctuation\">)</span>  \n                    <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connected!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<br>\n<p>생성자를 통해 만료시간을 설정할 수 있습니다. 디폴트 값은 서버에 따라 다릅니다. 내장 톰캣을 사용하면 30초정도 되는 것 같습니다. 만료시간이 다되면 <strong>브라우저에서 자동으로 서버에 재연결 요청</strong>을 보냅니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SseEmitter</span> emitter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">(</span><span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>이때 생성된 <code class=\"language-text\">SseEmitter</code> 객체는 향후 이벤트가 발생했을 때, 해당 클라이언트로 이벤트를 전송하기 위해 사용되므로 서버에서 저장하고 있어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">sseEmitters<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>주의해야할 점은 처음 Emitter를 생성할 때, 아무 데이터도 넣지 않으면 503 Service Unavailable 에러가 발생합니다. 따라서 생성할 때는 아무 데이터라도 넣어줘야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">emitter<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">.</span><span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connect\"</span><span class=\"token punctuation\">)</span>         <span class=\"token comment\">// 해당 이벤트의 이름 지정</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connected!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 503 에러 방지를 위한 더미 데이터</span></code></pre></div>\n<br>\n<p>이벤트 이름을 설정해주면 클라이언트에서 해당 이름으로 이벤트를 받을 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\n<span class=\"token keyword\">const</span> sse <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EventSource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080/connect\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nsse<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connect'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> receivedConnectData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>\n\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connect event data: '</span><span class=\"token punctuation\">,</span>receivedConnectData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// \"connected!\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<br>\n<p><code class=\"language-text\">SseEmitter</code>를 생성할 때는 비동기 요청이 완료되거나 타임아웃 발생 시 실행할 콜백을 등록할 수 있습니다. 타임아웃이 발생하면 브라우저에서 재연결 요청을 보내는데, 이때 새로운 Emitter 객체를 다시 생성하기 때문에(<code class=\"language-text\">SseController</code>의 <code class=\"language-text\">connect()</code>메서드 참조) 기존의 Emitter를 제거해주어야 합니다. 따라서 <code class=\"language-text\">onCompletion</code> 콜백에서 자기 자신을 지우도록 등록합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>  \n<span class=\"token annotation punctuation\">@Slf4j</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SseEmitters</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">></span></span> emitters <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CopyOnWriteArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token class-name\">SseEmitter</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitter</span> emitter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>emitters<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"new emitter added: {}\"</span><span class=\"token punctuation\">,</span> emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"emitter list size: {}\"</span><span class=\"token punctuation\">,</span> emitters<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        emitter<span class=\"token punctuation\">.</span><span class=\"token function\">onCompletion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onCompletion callback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>emitters<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>emitter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 만료되면 리스트에서 삭제</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        emitter<span class=\"token punctuation\">.</span><span class=\"token function\">onTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onTimeout callback\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            emitter<span class=\"token punctuation\">.</span><span class=\"token function\">complete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n        <span class=\"token keyword\">return</span> emitter<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>주의할 점은 이 콜백이 <strong>SseEmitter를 관리하는 다른 스레드에서 실행</strong>된다는 것입니다. 따라서 <code class=\"language-text\">thread-safe</code>한 자료구조를 사용하지 않으면 <code class=\"language-text\">ConcurrnetModificationException</code>이 발생할 수 있습니다. 여기서는 thread-safe한 리스트인 <code class=\"language-text\">CopyOnWriteArrayList</code>를 사용하였습니다.</p>\n<p>이제 서버에서 무언가 변경 사항이 생겼을 떄, 클라이언트의 요청이 없어도 데이터를 전송할 수 있습니다. 본 예시에서는 누군가 <code class=\"language-text\">/count</code>를 호출하면 서버에 저장된 숫자를 1 증가시키고 이를 SSE 통신 중인 모든 클라이언트에게 전달하도록 해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>  \n<span class=\"token annotation punctuation\">@Slf4j</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SseController</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SseEmitters</span> sseEmitters<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SseController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitters</span> sseEmitters<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sseEmitters <span class=\"token operator\">=</span> sseEmitters<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n\n\t<span class=\"token comment\">// ...</span>\n  \n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/count\"</span><span class=\"token punctuation\">)</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        sseEmitters<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>  \n<span class=\"token annotation punctuation\">@Slf4j</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SseEmitters</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AtomicLong</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicLong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">></span></span> emitters <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CopyOnWriteArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n\t<span class=\"token comment\">// ...</span>\n\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">long</span> count <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">.</span><span class=\"token function\">incrementAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        emitters<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>emitter <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n                emitter<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SseEmitter</span><span class=\"token punctuation\">.</span><span class=\"token function\">event</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n                        <span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count\"</span><span class=\"token punctuation\">)</span>  \n                        <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span>  \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<br>\n클라이언트에서는 `count`라는 이름의 이벤트가 발생할 때 콘솔에 변경된 데이터를 찍도록 이벤트 리스너를 등록해둡니다.\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">sse<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token char\">'count'</span><span class=\"token punctuation\">,</span> e <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> receivedCount <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">;</span>  \n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"count event data\"</span><span class=\"token punctuation\">,</span>receivedCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>receivedCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>이제 만약 다른 브라우저에서 count를 호출한다면 내 브라우저에 서버에서 변경된 값이 찍히게 됩니다.</p>\n<h2>주의점</h2>\n<p>스프링에서도 API를 지원해주고 있기 때문에 SSE 통신을 구현하는 것 자체는 굉장히 쉽습니다. 하지만 기능을 구현하고 서비스에 배포하기까지 여러 어려움들을 겪었는데요, SSE 통신을 구현하면서 진행한 트러블슈팅을 공유하면서 글을 마치도록 하겠습니다.</p>\n<h3>503 Service Unavailable</h3>\n<p>위에서 언급했듯이 처음에 SSE 응답을 할 때 아무런 이벤트도 보내지 않으면 재연결 요청을 보낼때나, 아니면 연결 요청 자체에서 오류가 발생합니다.</p>\n<p>따라서 첫 SSE 응답을 보낼 시에는 반드시 더미 데이터라도 넣어서 데이터를 전달해야합니다.</p>\n<h3>헤더에 토큰 전달</h3>\n<p>SSE 연결 요청을 할 때 헤더로 JWT를 담아서 보내줘야하는 상황이었는데, <code class=\"language-text\">EventSource</code> 인터페이스는 기본적으로 헤더 전달을 지원하지 않습니다. <a href=\"https://www.npmjs.com/package/event-source-polyfill\">event-source-polyfill</a> 을 사용하면 헤더를 함께 보낼 수 있습니다.</p>\n<h3>JPA 사용시 Connection 고갈 문제</h3>\n<p>QA를 하다가 발견한 문제입니다. <strong>SSE 통신을 하는 동안은 HTTP Connection이 계속 열려있습니다.</strong> 만약 SSE 연결 응답 API에서 JPA를 사용하고 <code class=\"language-text\">open-in-view</code> 속성이 true로 되어있다면, <strong>HTTP Connection이 열려있는 동안 DB Connection도 같이 열려있게 됩니다.</strong></p>\n<p>즉 DB Connection Pool에서 최대 10개의 Connection을 사용할 수 있다면, <strong>10명의 클라이언트가 SSE 연결 요청을 하는 순간 DB 커넥션도 고갈되게 됩니다.</strong> 따라서 이 경우 <code class=\"language-text\">open-in-view</code> 설정을 반드시 false로 설정해야 합니다.</p>\n<h3>ConcurrentModificationException</h3>\n<p>마찬가지로 위에서 언급했듯이, <code class=\"language-text\">onCompletion</code>, <code class=\"language-text\">onTimeout</code> 콜백은 별도의 스레드에서 호출됩니다. 만약 이 콜백을 통해 <code class=\"language-text\">SseEmitter</code> 객체가 담긴 컬렉션에 연산을 한다면 해당 컬렉션은 thread-safe한 자료구조를 사용해야합니다. 처음에 그냥 <code class=\"language-text\">ArrayList</code>를 사용했다가 SseEmitter가 만료될 때마다 ConcurrentModificationException이 발생하는 문제를 겪었었습니다.</p>\n<h3>Nginx 사용시 주의할 점</h3>\n<p>로컬에서 잘 동작하는 것을 확인하고 배포를 했더니 SSE 통신이 동작하지 않는 문제가 발생했었습니다.</p>\n<p>저희 팀은 리버스 프록시로 Nginx를 사용하고 있었는데요</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dev-blog/static/4b12547a044695854a0d7371e37c9051/9c1e6/arch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB90lEQVQoz3WTzW7TQBRG84Y8CW/Ang0LhJBgwQ6xYUEFLNhURGVRhFSkCiFElTY0TuzE9owd/41nPPYclElKQ6Ne2Z7xaHR0v+/eO3LO8V9YRZ9O6ccvoI5xpvbHB/fuidHm03UdVV1TrjNMFtEMls/zrwy9gUbitkQPvQHvr36/+/dAKQRCCIpcYmSErFe8m3zCtmtQ+SHwzrq/3wLLEtPbbc4biJhCHvjX6WoH9A83wj1oT6rbl6yDP9ii2nnY0suA7ssraFIYut15g/n+AS7G3mcfvcaKGWr8HMoI1ylGayU4eviI2fun1LWgFRHKar5NT3CDoREhMl5AZ7iKTgnlD1AlIo1ps4i+0yTRNVjt/R4lWvLg7WN+nT9BrVOMXCKV5M30mN7UqI2nqwB6OAmPOEvG0GrSZIXOlxitEFmM61rvt5ecimu03klWGS69hHKFk1PwbTPgNtUWCygFtNn2rqlw2QzEBIoI1xaMbG8JF0us7f/5QjyhPX4GZXLrIQNiGSDjOaoqqOqGYeihU947Zxpf6V2GKakQvg8bMeeyikgWZ0TVBVUSkK8L6rohWIQUVU3bapqmue3Fu41tu44wjIjmM8p0xuv5KWf5OR+vXvqihMsVQTBDSnEwGXf7cXQwUm2OjX8zLH/Cxh9THQDcPVOzyfAvR6OaBdqO4ZkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"프로젝트 아키텍처\"\n        title=\"프로젝트 아키텍처\"\n        src=\"/dev-blog/static/4b12547a044695854a0d7371e37c9051/f058b/arch.png\"\n        srcset=\"/dev-blog/static/4b12547a044695854a0d7371e37c9051/c26ae/arch.png 158w,\n/dev-blog/static/4b12547a044695854a0d7371e37c9051/6bdcf/arch.png 315w,\n/dev-blog/static/4b12547a044695854a0d7371e37c9051/f058b/arch.png 630w,\n/dev-blog/static/4b12547a044695854a0d7371e37c9051/40601/arch.png 945w,\n/dev-blog/static/4b12547a044695854a0d7371e37c9051/78612/arch.png 1260w,\n/dev-blog/static/4b12547a044695854a0d7371e37c9051/9c1e6/arch.png 1734w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>원인을 찾아보던 중 Nginx는 기본적으로 Upstream으로 요청을 보낼때 HTTP/1.0 버전을 사용한다는 것을 확인했습니다.</p>\n<p>HTTP/1.1은 지속 연결이 기본이기 때문에 헤더를 따로 설정해줄 필요가 없지만, <strong>Nginx에서 백엔드 WAS로 요청을 보낼 때는 HTTP/1.0을 사용하고 <code class=\"language-text\">Connection: close</code> 헤더를 사용</strong>하게 됩니다.</p>\n<p>SSE는 지속 연결이 되어 있어야 동작하는데 Nginx에서 지속 연결을 닫아버려 제대로 동작하지 않았습니다.</p>\n<p>따라서 아래와 같이 nginx 설정을 추가해야 제대로 동작합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">''</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token directive\"><span class=\"token keyword\">proxy_http_version</span> 1.1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>또 Nginx의 proxy buffering 기능도 조심해야 하는데요, SSE 통신에서 서버는 기본적으로 응답에 <code class=\"language-text\">Transfer-Encoding: chunked</code>를 사용합니다. SSE는 서버에서 동적으로 생성된 컨텐츠를 스트리밍하기 때문에 본문의 크기를 미리 알 수 없기 때문입니다.</p>\n<p>Nginx는 서버의 응답을 버퍼에 저장해두었다가 버퍼가 차거나 서버가 응답 데이터를 모두 보내면 클라이언트로 전송하게 됩니다.</p>\n<blockquote>\n<p>참고: <a href=\"https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/\">https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/</a></p>\n</blockquote>\n<p>문제는 버퍼링 기능을 활성화하면 <strong>SSE 통신 시 원하는대로 동작하지 않거나 실시간성이 떨어지게 된다는 것</strong>입니다. 따라서 SSE 응답에 대해서는 proxy buffering 설정을 비활성화 해주는 것이 좋습니다.</p>\n<p>하지만 Nginx의 설정 파일에서 버퍼링을 비활성화하면 다른 모든 API 응답에 대해서도 버퍼링을 하지 않기 때문에 비효율적일 수 있습니다. 이때 nginx의 <a href=\"https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/\">X-accel</a> 기능을 활용하면 좋습니다.</p>\n<p>백엔드의 응답 헤더에 X-accel로 시작하는 헤더가 있으면 Nginx가 이 정보를 이용해 내부적인 처리를 따로 하도록 만들 수 있습니다. 따라서 SSE 응답을 반환하는 API의 헤더에 <code class=\"language-text\">X-Accel-Buffering: no</code>를 붙여주면 SSE 응답만 버퍼링을 하지 않도록 설정할 수 있습니다.</p>\n<h3>스케일 아웃 시 문제</h3>\n<p>아직은 스케일 아웃을 하지 않아서 직접 트러블 슈팅을 하지는 않았지만, 서버를 늘리고 로드밸런싱을 하게 될 경우 현재 코드는 제대로 동작하지 않습니다. <code class=\"language-text\">SseEmitter</code> 객체를 서버의 메모리에서 저장하고 있기 때문입니다.</p>\n<p>서버 인스턴스를 늘릴 때 좀 더 고민해봐야겠지만 현재는 <a href=\"https://redis.io/docs/manual/pubsub/\">Redis Pub/Sub</a>을 이용하여 해결할 수 있을 것으로 생각하고 있습니다.</p>\n<h2>마무리</h2>\n<p>사실 저희 프로젝트 요구 사항으로는 Server-Sent Events보다는 Websocket을 이용하는 것이 더 적합하다고 생각하고 있습니다. Server-Sent Events는 서버에서 클라이언트로의 단방향 통신만 가능하기 때문에 클라이언트의 상호작용 없이 서버로부터 데이터가 전달되어야 하는 상황에 적합하기 때문입니다. 대표적으로 스포츠 중계 서비스나 SNS 피드 같은 성격의 서비스가 그러합니다.</p>\n<p>우선은 프로토콜을 추가로 사용하지 않고 바로 기능을 서비스하기 위해 SSE를 사용하였지만 추후 Websocket을 적용할 것을 고려하고 있습니다.</p>\n<h3>참고자료</h3>\n<ul>\n<li><a href=\"https://github.com/aliakh/demo-spring-sse\">https://github.com/aliakh/demo-spring-sse</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/EventSource\">MDN EventSource</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/4.2.0.RC2_to_4.2.0.RC3/Spring%20Framework%204.2.0.RC3/org/springframework/web/servlet/mvc/method/annotation/SseEmitter.html\">SseEmitter API</a></li>\n<li><a href=\"https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/\">Nginx X-accel</a></li>\n<li><a href=\"https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/\">Nginx reverse proxy guide</a></li>\n</ul>","fields":{"slug":"/BE/어썸오/sse/sse/"},"frontmatter":{"title":"Server-Sent Events를 이용한 비동기 통신 구현 및 트러블슈팅","date":"2022.10.04","description":"SSE 통신 구현 및 관련 트러블슈팅 경험을 공유합니다.","tags":["spring","SSE"]}}},"pageContext":{"id":"be2a70d3-e2c8-563c-be43-005450c9ef90","previousPostId":"b0207c5a-083f-5d84-8419-8646dc49124b","nextPostId":"d310ac0f-0bfa-5fcd-950a-1d72e996ae01"}},"staticQueryHashes":["2841359383"]}